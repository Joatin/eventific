{"version":3,"file":"CommandManager.js","sourceRoot":"","sources":["../../src/CommandManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { CommandMessage, IAggregate, IStore, Injector, InternalLogger, Logger, IEventHandler, Bootstrapable, ITransport, Store } from '@eventific/core';\nimport * as emoji from 'node-emoji';\nimport chalk from 'chalk';\n\nconst pascalCase = require('pascal-case');\n\nexport interface CommandManagerOptions {\n  extensions?: any[];\n  aggregate: {\n    _InstantiateAggregate(injector: Injector): IAggregate;\n  };\n  store: {\n    _CreateStore(injector: Injector): IStore\n  };\n  transports: Array<{\n    _CreateTransport(injector: Injector): ITransport\n  }>;\n  providers?: any[];\n}\n\nexport abstract class ICommandManager extends Bootstrapable{\n\n}\n\n/**\n *\n * @param {CommandManagerOptions} options\n * @returns T The decorated class\n * @Annotation\n */\nexport function CommandManager(options: CommandManagerOptions) {\n\n  return <T extends {new(...args: any[]): {}}>(Class: T) => {\n    return class extends Class {\n      public static Type = 'CommandManager';\n      public static _Instantiate(parentInjector: Injector): T {\n        const injector = parentInjector.newChildInjector();\n        const store = options.store._CreateStore(injector);\n        injector.set({provide: Store, useConstant: store});\n        injector.set({provide: Logger, useConstant: new InternalLogger(chalk.green(pascalCase('CommandManager')))});\n\n        return new this({\n          injector,\n          store,\n          transports: options.transports.map((t) => t._CreateTransport(injector)) || [],\n          aggregate: options.aggregate._InstantiateAggregate(injector)\n        }) as any;\n      }\n\n      readonly _injector: Injector;\n      readonly _store: IStore;\n      readonly _transports: ITransport[];\n      readonly _aggregate: IAggregate;\n      readonly _logger: Logger;\n\n      constructor(...args: any[]) {\n        super(...args[0].injector.args(Class));\n        const params = args[0];\n        this._injector = params.injector;\n        this._store = params.store;\n        this._transports = params.transports;\n        this._aggregate = params.aggregate;\n        this._logger = this._injector.get<Logger>(Logger);\n      }\n\n      public async _start() {\n        if (this.onInit) {\n          await this.onInit();\n        }\n\n        await this._store.start();\n\n        for (const transport of this._transports) {\n          await transport.start();\n          if(transport.onCommand) {\n            transport.onCommand(async (cmd: any) => {\n              await this._handleCommand(cmd);\n            });\n          }\n        }\n        this._logger.info(`All setup and ready ${emoji.get('sparkles')}`)\n      }\n\n      public async _handleCommand(commandMessage: CommandMessage): Promise<void> {\n        await this._aggregate.handleCommand(commandMessage);\n\n        // const command = await this._aggregate.getCommand(commandMessage);\n        // const stateDef = await this._aggregate.getState(command.aggregateId);\n        // let events: IEvent[];\n        // try {\n        //   events = await command.handle(stateDef.state, stateDef.version);\n        // } catch(ex) {\n        //   this._logger.warn(`Command handler ${command.name} threw an error upon execution`, ex);\n        //   throw ex;\n        // }\n        // if(!events || events.length <= 0) {\n        //   this._logger.error(`Command handler ${command.name} did not return any events. A command has to return at least one event!`);\n        //   throw Error('Internal Server Error');\n        // }\n        // await this._store.applyEvents(this._aggregate.name, events.map((e) => e.toMessage()));\n      }\n\n      public onInit?: () => void;\n\n    };\n  };\n}\n"]}